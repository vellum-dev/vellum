name: Cleanup Testing Repo

on:
  pull_request_target:
    types: [closed]

permissions:
  pull-requests: write
  issues: write
  contents: read

jobs:
  remove-labels:
    runs-on: ubuntu-latest
    steps:
      - name: Remove PR labels
        uses: actions/github-script@v7
        with:
          script: |
            const labels = ['ready-for-review', 'testing-repo'];
            const prLabels = context.payload.pull_request.labels.map(l => l.name);
            for (const label of labels) {
              if (prLabels.includes(label)) {
                await github.rest.issues.removeLabel({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  issue_number: context.payload.pull_request.number,
                  name: label,
                });
              }
            }

  cleanup:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Get changed packages via API
        id: detect
        uses: actions/github-script@v7
        with:
          script: |
            const { data: files } = await github.rest.pulls.listFiles({
              owner: context.repo.owner,
              repo: context.repo.repo,
              pull_number: context.payload.pull_request.number,
              per_page: 100
            });
            const packages = [...new Set(
              files
                .map(f => f.filename)
                .filter(f => f.startsWith('packages/'))
                .map(f => f.split('/')[1])
                .filter(p => p && !/[*?\[\]]/.test(p))
            )];
            const result = packages.join(' ');
            console.log(`Detected packages: ${result || '(none)'}`);
            core.setOutput('packages', result);

      - name: Set up signing key
        if: steps.detect.outputs.packages != ''
        run: |
          if [ -n "$SIGNING_KEY" ]; then
            echo "$SIGNING_KEY" > keys/packages.rsa
            chmod 600 keys/packages.rsa
          fi
        env:
          SIGNING_KEY: ${{ secrets.SIGNING_KEY }}

      - name: Configure AWS credentials
        if: steps.detect.outputs.packages != ''
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: us-east-2

      - name: Remove packages from S3
        if: steps.detect.outputs.packages != ''
        env:
          PACKAGES: ${{ steps.detect.outputs.packages }}
        run: |
          for pkg in $PACKAGES; do
            for arch in aarch64 armv7; do
              echo "Removing ${pkg} from $arch..."
              aws s3 rm "s3://packages.vellum.delivery/testing/$arch/" \
                --recursive --exclude "*" --include "${pkg}-*.apk" || true
            done
          done

      - name: Regenerate APKINDEX
        if: steps.detect.outputs.packages != ''
        run: |
          for arch in aarch64 armv7; do
            echo "Processing $arch..."
            mkdir -p s3-packages/$arch

            aws s3 cp s3://packages.vellum.delivery/testing/$arch/ s3-packages/$arch/ \
              --recursive --exclude "APKINDEX.tar.gz" || true

            if ls s3-packages/$arch/*.apk >/dev/null 2>&1; then
              echo "Regenerating APKINDEX for $arch with $(ls s3-packages/$arch/*.apk | wc -l) packages..."

              if [ -f "keys/packages.rsa" ]; then
                docker run --rm \
                  -v "$PWD/s3-packages/$arch:/packages:Z" \
                  -v "$PWD/keys:/keys:ro" \
                  -w /packages \
                  alpine:edge \
                  sh -c "
                    apk add --no-cache apk-tools abuild
                    cp /keys/packages.rsa.pub /etc/apk/keys/
                    apk index --rewrite-arch $arch -o APKINDEX.tar.gz *.apk
                    abuild-sign -k /keys/packages.rsa APKINDEX.tar.gz
                  "
              else
                echo "No signing key available, generating unsigned index"
                docker run --rm \
                  -v "$PWD/s3-packages/$arch:/packages:Z" \
                  -w /packages \
                  alpine:edge \
                  sh -c "
                    apk add --no-cache apk-tools
                    apk index --rewrite-arch $arch -o APKINDEX.tar.gz *.apk
                  "
              fi

              aws s3 cp s3-packages/$arch/APKINDEX.tar.gz \
                s3://packages.vellum.delivery/testing/$arch/APKINDEX.tar.gz
            else
              echo "No packages in $arch, removing index..."
              aws s3 rm s3://packages.vellum.delivery/testing/$arch/APKINDEX.tar.gz || true
            fi
          done
