name: Ready for Review

on:
  issue_comment:
    types: [created]
  pull_request_review:
    types: [submitted]

permissions:
  pull-requests: write
  issues: write

jobs:
  ready-for-review-command:
    if: |
      github.event_name == 'issue_comment' &&
      github.event.issue.pull_request &&
      contains(github.event.comment.body, '/ready-for-review')
    runs-on: ubuntu-latest
    steps:
      - name: Verify author and process command
        uses: actions/github-script@v7
        env:
          COMMENT_BODY: ${{ github.event.comment.body }}
        with:
          script: |
            const { data: pr } = await github.rest.pulls.get({
              owner: context.repo.owner,
              repo: context.repo.repo,
              pull_number: context.issue.number
            });

            if (context.payload.comment.user.login !== pr.user.login) {
              await github.rest.reactions.createForIssueComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                comment_id: context.payload.comment.id,
                content: 'confused'
              });
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.issue.number,
                body: `Only the PR author can use \`/ready-for-review\`.`
              });
              return;
            }

            const query = `query($owner: String!, $repo: String!, $number: Int!) {
              repository(owner: $owner, name: $repo) {
                pullRequest(number: $number) {
                  reviewThreads(first: 100) {
                    nodes {
                      isResolved
                      comments(first: 1) {
                        nodes {
                          body
                          url
                        }
                      }
                    }
                  }
                }
              }
            }`;

            const result = await github.graphql(query, {
              owner: context.repo.owner,
              repo: context.repo.repo,
              number: context.issue.number
            });

            const unresolved = result.repository.pullRequest.reviewThreads.nodes.filter(t => !t.isResolved);

            if (unresolved.length > 0) {
              const list = unresolved.map(t => {
                const comment = t.comments.nodes[0];
                const preview = comment.body.substring(0, 80).replace(/\n/g, ' ');
                return `- [${preview}](${comment.url})`;
              }).join('\n');

              await github.rest.reactions.createForIssueComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                comment_id: context.payload.comment.id,
                content: '-1'
              });
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.issue.number,
                body: `There are ${unresolved.length} unresolved review conversation(s). Please resolve them before marking as ready.\n\n${list}`
              });
              return;
            }

            try {
              await github.rest.issues.getLabel({
                owner: context.repo.owner,
                repo: context.repo.repo,
                name: 'ready-for-review'
              });
            } catch {
              await github.rest.issues.createLabel({
                owner: context.repo.owner,
                repo: context.repo.repo,
                name: 'ready-for-review',
                color: '0e8a16'
              });
            }

            const { data: labels } = await github.rest.issues.listLabelsOnIssue({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number
            });

            const alreadyLabeled = labels.some(l => l.name === 'ready-for-review');

            await github.rest.issues.addLabels({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              labels: ['ready-for-review']
            });

            if (!alreadyLabeled) {
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.issue.number,
                body: `@vellum-dev/package-approvers this PR is ready for review.`
              });
            }

            await github.rest.reactions.createForIssueComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              comment_id: context.payload.comment.id,
              content: 'rocket'
            });

  not-ready-command:
    if: |
      github.event_name == 'issue_comment' &&
      github.event.issue.pull_request &&
      contains(github.event.comment.body, '/not-ready')
    runs-on: ubuntu-latest
    steps:
      - name: Verify author and process command
        uses: actions/github-script@v7
        env:
          COMMENT_BODY: ${{ github.event.comment.body }}
        with:
          script: |
            const { data: pr } = await github.rest.pulls.get({
              owner: context.repo.owner,
              repo: context.repo.repo,
              pull_number: context.issue.number
            });

            if (context.payload.comment.user.login !== pr.user.login) {
              await github.rest.reactions.createForIssueComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                comment_id: context.payload.comment.id,
                content: 'confused'
              });
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.issue.number,
                body: `Only the PR author can use \`/not-ready\`.`
              });
              return;
            }

            try {
              await github.rest.issues.removeLabel({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.issue.number,
                name: 'ready-for-review'
              });
            } catch {
            }

            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              body: 'Marked as not ready for review. Use `/ready-for-review` when ready again.'
            });

            await github.rest.reactions.createForIssueComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              comment_id: context.payload.comment.id,
              content: 'eyes'
            });

  remove-label-on-review:
    if: |
      github.event_name == 'pull_request_review' &&
      github.event.review.state != 'approved'
    runs-on: ubuntu-latest
    steps:
      - name: Remove ready-for-review label
        uses: actions/github-script@v7
        with:
          script: |
            try {
              await github.rest.issues.removeLabel({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.payload.pull_request.number,
                name: 'ready-for-review'
              });
            } catch {
            }
