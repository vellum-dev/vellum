name: Build Packages

on:
  push: &branches
    branches:
      - main
  pull_request: *branches
  workflow_dispatch:
    inputs:
      rebuild_all:
        description: "Rebuild all packages (ignore change detection)"
        type: boolean
        default: false
      reindex_only:
        description: "Only regenerate APKINDEX from S3 (no builds)"
        type: boolean
        default: false

jobs:
  setup:
    if: ${{ github.event.inputs.reindex_only != 'true' }}
    runs-on: ubuntu-latest
    outputs:
      packages: ${{ steps.changed.outputs.packages }}
      noarch: ${{ steps.generate-matrix.outputs.noarch }}
      multiarch: ${{ steps.generate-matrix.outputs.multiarch }}
      has_packages: ${{ steps.generate-matrix.outputs.has_packages }}
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Check if fork
        if: github.event_name == 'pull_request'
        run: |
          if [ "${{ github.event.pull_request.head.repo.full_name }}" != "${{ github.repository }}" ]; then
            echo "::notice::Building from fork - signing disabled, artifacts only"
          fi

      - name: Detect changed packages
        id: changed
        run: |
          if [ "${{ github.event.inputs.rebuild_all }}" == "true" ]; then
            echo "Rebuild all requested - building all packages"
            echo "packages=all" >> $GITHUB_OUTPUT
          elif [ "${{ github.event_name }}" == "push" ]; then
            BEFORE="${{ github.event.before }}"
            if ! git cat-file -e "$BEFORE" 2>/dev/null; then
              echo "Before commit not accessible (likely force-push), using HEAD~1"
              BEFORE="HEAD~1"
            fi
            CHANGED=$(git diff --name-only "$BEFORE" ${{ github.sha }} | \
              grep '^packages/' | cut -d/ -f2 | grep -v '[*?\[\]]' | sort -u | tr '\n' ' ' || echo "")
            if [ -z "$CHANGED" ]; then
              echo "No package changes detected"
              echo "packages=" >> $GITHUB_OUTPUT
            else
              echo "Changed packages: $CHANGED"
              echo "packages=$CHANGED" >> $GITHUB_OUTPUT
            fi
          elif [ "${{ github.event_name }}" == "pull_request" ]; then
            CHANGED=$(git diff --name-only origin/${{ github.base_ref }}...HEAD | \
              grep '^packages/' | cut -d/ -f2 | grep -v '[*?\[\]]' | sort -u | tr '\n' ' ' || echo "")
            if [ -z "$CHANGED" ]; then
              echo "No package changes detected"
              echo "packages=" >> $GITHUB_OUTPUT
            else
              echo "Changed packages: $CHANGED"
              echo "packages=$CHANGED" >> $GITHUB_OUTPUT
            fi
          else
            # workflow_dispatch without rebuild_all - build all
            echo "packages=all" >> $GITHUB_OUTPUT
          fi

      - name: Generate package matrix
        id: generate-matrix
        run: |
          CHANGED="${{ steps.changed.outputs.packages }}"

          # Get all noarch packages
          all_noarch=$(for pkg in packages/*/VELBUILD; do
            if grep -q '^arch="noarch"' "$pkg"; then
              basename $(dirname "$pkg")
            fi
          done)

          # Get all multiarch packages
          all_multiarch=$(for pkg in packages/*/VELBUILD; do
            if grep -qE '^arch="(aarch64|armv7|aarch64 armv7)"' "$pkg"; then
              basename $(dirname "$pkg")
            fi
          done)

          # Filter to only changed packages (unless rebuild_all)
          if [ "$CHANGED" == "all" ]; then
            noarch_packages="$all_noarch"
            multiarch_packages="$all_multiarch"
          elif [ -z "$CHANGED" ]; then
            noarch_packages=""
            multiarch_packages=""
          else
            noarch_packages=""
            multiarch_packages=""
            for pkg in $CHANGED; do
              if echo "$all_noarch" | grep -qx "$pkg"; then
                noarch_packages="$noarch_packages $pkg"
              fi
              if echo "$all_multiarch" | grep -qx "$pkg"; then
                multiarch_packages="$multiarch_packages $pkg"
              fi
            done
          fi

          # Convert to JSON arrays
          noarch_json=$(echo "$noarch_packages" | tr ' ' '\n' | grep -v '^$' | jq -R -s -c 'split("\n") | map(select(length > 0))')
          multiarch_json=$(echo "$multiarch_packages" | tr ' ' '\n' | grep -v '^$' | jq -R -s -c 'split("\n") | map(select(length > 0))')

          echo "noarch=$noarch_json" >> $GITHUB_OUTPUT
          echo "multiarch=$multiarch_json" >> $GITHUB_OUTPUT

          # Check if we have any packages to build
          if [ "$noarch_json" == "[]" ] && [ "$multiarch_json" == "[]" ]; then
            echo "has_packages=false" >> $GITHUB_OUTPUT
            echo "No packages to build"
          else
            echo "has_packages=true" >> $GITHUB_OUTPUT
            echo "Noarch packages: $noarch_json"
            echo "Multiarch packages: $multiarch_json"
          fi

  lint:
    needs: setup
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - &install-vbuild
        name: Install vbuild
        run: |
          set -e
          curl \
            --location \
            'https://github.com/Eeems/vbuild/releases/download/0.0.11/vbuild-vbuild-ubuntu' \
            --output /usr/local/bin/vbuild
          chmod +x /usr/local/bin/vbuild

      - name: Lint VELBUILD files
        run: |
          PACKAGES="${{ needs.setup.outputs.packages }}"
          if [ "$PACKAGES" == "all" ] || [ -z "$PACKAGES" ]; then
            ./scripts/lint-packages.sh --apkbuild-lint
          else
            ./scripts/lint-packages.sh --apkbuild-lint $PACKAGES
          fi

  build-noarch:
    needs: [lint, setup]
    if: |
      needs.setup.outputs.has_packages == 'true' &&
      fromJson(needs.setup.outputs.noarch)[0] != null
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        package: ${{ fromJson(needs.setup.outputs.noarch) }}

    steps:
      - uses: actions/checkout@v4

      - *install-vbuild

      - &set-up-signing-key
        name: Set up signing key
        id: signing
        run: |
          if [ -n "${{ secrets.SIGNING_KEY }}" ]; then
            echo "${{ secrets.SIGNING_KEY }}" > keys/packages.rsa
            chmod 600 keys/packages.rsa
            echo "has_key=true" >> $GITHUB_OUTPUT
          fi

      - name: Build ${{ matrix.package }}
        run: ./scripts/build-package.sh "${{ matrix.package }}"

      - &verify-signature
        name: Verify package signatures
        if: steps.signing.outputs.has_key == 'true'
        run: |
          docker run --rm \
            -v "$PWD/dist:/dist:ro" \
            -v "$PWD/keys:/keys:ro" \
            ghcr.io/eeems/vbuild-builder:main \
            sh -c "
              cp /keys/packages.rsa.pub /etc/apk/keys/
              for apk in /dist/*/*.apk; do
                [ -f \"\$apk\" ] || continue
                apk verify \"\$apk\" || exit 1
              done
            "

      - &get-package-name
        name: Get package name from VELBUILD
        id: pkgname
        run: |
          pkgname=$(grep '^pkgname=' packages/${{ matrix.package }}/VELBUILD | cut -d= -f2)
          echo "name=$pkgname" >> $GITHUB_OUTPUT

      - name: Upload artifact
        if: github.event_name == 'pull_request'
        uses: actions/upload-artifact@v4
        with:
          name: ${{ matrix.package }}-noarch
          path: dist/noarch/${{ steps.pkgname.outputs.name }}-*.apk
          if-no-files-found: error

      - &upload-to-s3
        name: Upload to S3
        if: github.repository == 'vellum-dev/vellum' && github.ref == 'refs/heads/main' && github.event_name != 'pull_request'
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: us-east-2

      - name: Upload packages to S3
        if: github.repository == 'vellum-dev/vellum' && github.ref == 'refs/heads/main' && github.event_name != 'pull_request'
        run: |
          for arch in aarch64 armv7; do
            if [ -d "dist/noarch" ] && ls dist/noarch/*.apk >/dev/null 2>&1; then
              aws s3 cp dist/noarch/ s3://packages.vellum.delivery/$arch/ --recursive --exclude "APKINDEX.tar.gz"
            fi
          done

  build-multi-arch:
    needs: [lint, setup]
    if: |
      needs.setup.outputs.has_packages == 'true' &&
      fromJson(needs.setup.outputs.multiarch)[0] != null
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        package: ${{ fromJson(needs.setup.outputs.multiarch) }}
        arch: [aarch64, armv7]

    steps:
      - uses: actions/checkout@v4

      - *install-vbuild

      - *set-up-signing-key

      - name: Build ${{ matrix.package }} for ${{ matrix.arch }}
        run: ./scripts/build-package.sh "${{ matrix.package }}" "${{ matrix.arch }}"

      - *verify-signature

      - *get-package-name

      - name: Upload artifact
        if: github.event_name == 'pull_request'
        uses: actions/upload-artifact@v4
        with:
          name: ${{ matrix.package }}-${{ matrix.arch }}
          path: dist/${{ matrix.arch }}/${{ steps.pkgname.outputs.name }}-*.apk
          if-no-files-found: warn

      - *upload-to-s3

      - name: Upload packages to S3
        if: github.repository == 'vellum-dev/vellum' && github.ref == 'refs/heads/main' && github.event_name != 'pull_request'
        run: |
          if [ -d "dist/${{ matrix.arch }}" ] && ls dist/${{ matrix.arch }}/*.apk >/dev/null 2>&1; then
            aws s3 cp dist/${{ matrix.arch }}/ s3://packages.vellum.delivery/${{ matrix.arch }}/ --recursive --exclude "APKINDEX.tar.gz"
          fi

  deploy:
    needs: [setup, build-noarch, build-multi-arch]
    runs-on: ubuntu-latest
    if: >-
      always() &&
      !failure() &&
      !cancelled() &&
      github.repository == 'vellum-dev/vellum' &&
      (
        github.event.inputs.reindex_only == 'true' ||
        (github.ref == 'refs/heads/main' && github.event_name != 'pull_request')
      )
    steps:
      - uses: actions/checkout@v4

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: us-east-2

      - *set-up-signing-key

      - name: Regenerate APKINDEX from S3
        run: |
          for arch in aarch64 armv7; do
            echo "Processing $arch..."

            mkdir -p s3-packages/$arch
            aws s3 cp s3://packages.vellum.delivery/$arch/ s3-packages/$arch/ \
              --recursive --exclude "APKINDEX.tar.gz" || true

            # Remove old pkgrels (keep only highest pkgrel per name-version)
            if ls s3-packages/$arch/*.apk >/dev/null 2>&1; then
              declare -A latest
              for f in s3-packages/$arch/*.apk; do
                b=$(basename "$f")
                [[ $b =~ ^(.*)-r([0-9]+)\.apk$ ]] || continue
                k="${BASH_REMATCH[1]}"; r="${BASH_REMATCH[2]}"
                [[ -z "${latest[$k]}" || "$r" -gt "${latest[$k]}" ]] && latest[$k]="$r"
              done
              for f in s3-packages/$arch/*.apk; do
                b=$(basename "$f")
                [[ $b =~ ^(.*)-r([0-9]+)\.apk$ ]] || continue
                k="${BASH_REMATCH[1]}"; r="${BASH_REMATCH[2]}"
                if [[ "$r" -lt "${latest[$k]}" ]]; then
                  echo "Removing old pkgrel: $b"
                  rm "$f"
                  aws s3 rm "s3://packages.vellum.delivery/$arch/$b"
                fi
              done
              unset latest
            fi

            if ls s3-packages/$arch/*.apk >/dev/null 2>&1; then
              echo "Regenerating APKINDEX for $arch with $(ls s3-packages/$arch/*.apk | wc -l) packages..."
              docker run --rm \
                -v "$PWD/s3-packages/$arch:/packages:Z" \
                -v "$PWD/keys:/keys:ro" \
                -w /packages \
                ghcr.io/eeems/vbuild-builder:main \
                sh -c "
                  cp /keys/packages.rsa.pub /etc/apk/keys/
                  apk index --rewrite-arch $arch -o APKINDEX.tar.gz *.apk
                  abuild-sign -k /keys/packages.rsa APKINDEX.tar.gz
                  chown $(id -u):$(id -g) APKINDEX.tar.gz
                "

              aws s3 cp s3-packages/$arch/APKINDEX.tar.gz \
                s3://packages.vellum.delivery/$arch/APKINDEX.tar.gz
            fi
          done

          echo "Deploy complete!"

      - name: Generate and upload package metadata
        run: |
          S3_BUCKET=packages.vellum.delivery ./scripts/generate-metadata.sh
          aws s3 cp packages-metadata.json s3://packages.vellum.delivery/packages-metadata.json \
            --content-type "application/json" \
            --cache-control "max-age=300"
          echo "Metadata uploaded to S3"

      - name: Generate RSS feeds
        run: ./scripts/generate-rss.sh packages-metadata.json

      - name: Commit metadata and feeds to vellum-index repository
        env:
          DEPLOY_KEY: ${{ secrets.VELLUM_SITE_DEPLOY_KEY }}
        run: |
          mkdir -p ~/.ssh
          echo "$DEPLOY_KEY" > ~/.ssh/vellum-index-key
          chmod 600 ~/.ssh/vellum-index-key
          ssh-keyscan github.com >> ~/.ssh/known_hosts

          export GIT_SSH_COMMAND="ssh -i ~/.ssh/vellum-index-key -o IdentitiesOnly=yes"

          git clone git@github.com:vellum-dev/vellum-index.git /tmp/vellum-index
          cd /tmp/vellum-index

          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

          cp $GITHUB_WORKSPACE/packages-metadata.json src/data/packages-metadata.json
          mkdir -p public/feeds
          cp $GITHUB_WORKSPACE/feeds/*.rss public/feeds/

          if git diff --quiet; then
            echo "No changes to commit"
          else
            git add src/data/packages-metadata.json public/feeds/
            git commit -m "Update packages metadata and RSS feeds

          Generated: $(date -u +"%Y-%m-%d %H:%M:%S UTC")
          Source commit: $GITHUB_SHA"

            git push origin main
            echo "Changes committed and pushed to vellum-index"
          fi
