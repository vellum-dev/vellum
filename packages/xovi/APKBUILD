maintainer="Mitchell Scott <mitchell@scottlabs.io>"
pkgname=xovi
pkgver=16.0.0
pkgrel=0
_upstream_author="asivery"
pkgdesc="Base xovi framework for reMarkable tablets"
url="https://github.com/asivery/rm-xovi-extensions"
arch="aarch64 armv7"
license="GPL-3.0"
depends="remarkable-os>=3.20 remarkable-os<3.25"
install="$pkgname.post-install $pkgname.pre-deinstall"
options="!check !fhs !strip !tracedeps"

subpackages="
	$pkgname-qt-resource-rebuilder:qt_resource_rebuilder
	$pkgname-webserver-remote:webserver_remote
	$pkgname-message-broker:message_broker
	$pkgname-command-executor:command_executor
	$pkgname-fileman:fileman
	$pkgname-framebuffer-spy:framebuffer_spy
	$pkgname-random-suspend:random_suspend
"

_release="v16-14112025"

source="
extensions-aarch64.zip::https://github.com/asivery/rm-xovi-extensions/releases/download/$_release/extensions-aarch64.zip
extensions-armv7.zip::https://github.com/asivery/rm-xovi-extensions/releases/download/$_release/extensions-arm32-testing.zip
LICENSE::https://raw.githubusercontent.com/asivery/rm-xovi-extensions/master/LICENSE
"

sha512sums="
2688a21c3f2e01f0b08fde3cb3a455907aa5f8ad9cd62599d0db21a5d533b7e60ad57a0755819879369c873966c25a53546fbf87d533150a44c2c6e0249fb532  extensions-aarch64.zip
e2b0231ef9e00859c9d094af2150031664d6ed414db05b0c6d9d0291273acb013fdd054b9f920f8f8974bb2c5402c85726c22e3af7af963637d76cace38fcb8c  extensions-armv7.zip
d361e5e8201481c6346ee6a886592c51265112be550d5224f1a7a6e116255c2f1ab8788df579d9b8372ed7bfd19bac4b6e70e00b472642966ab5b319b99a2686  LICENSE
"

prepare() {
	default_prepare
	cd "$srcdir"
	case "$CARCH" in
		aarch64) unzip -o extensions-aarch64.zip ;;
		armv7|armhf) unzip -o extensions-armv7.zip ;;
	esac
}

package() {
	install -Dm755 "$srcdir/install-xovi-for-rm" \
		"$pkgdir/home/root/.local/bin/install-xovi-for-rm"
	mkdir -p "$pkgdir/home/root/xovi/extensions.d"

	mkdir -p "$pkgdir/home/root/.vellum/licenses/$pkgname"
	install -Dm644 "$srcdir/LICENSE" \
		"$pkgdir/home/root/.vellum/licenses/$pkgname/LICENSE"
	echo "https://github.com/asivery/rm-xovi-extensions/archive/refs/tags/$_release.tar.gz" > \
		"$pkgdir/home/root/.vellum/licenses/$pkgname/SOURCES"
}

qt_resource_rebuilder() {
	pkgdesc="Rebuilds QT resource databases on the fly to replace or add QML files, images, etc"
	depends="xovi"
	install="$subpkgname.post-install"

	install -Dm755 "$srcdir/qt-resource-rebuilder.so" \
		"$subpkgdir/home/root/xovi/extensions.d/qt-resource-rebuilder.so"
	mkdir -p "$subpkgdir/home/root/xovi/exthome/qt-resource-rebuilder"
}

webserver_remote() {
	pkgdesc="Exposes the USB webserver to all interfaces with connection confirmation dialog"
	depends="xovi-qt-resource-rebuilder xovi-message-broker"

	install -Dm755 "$srcdir/webserver-remote.so" \
		"$subpkgdir/home/root/xovi/extensions.d/webserver-remote.so"
}

message_broker() {
	pkgdesc="IPC messaging between xovi extensions"
	depends="xovi"

	install -Dm755 "$srcdir/xovi-message-broker.so" \
		"$subpkgdir/home/root/xovi/extensions.d/xovi-message-broker.so"
}

command_executor() {
	pkgdesc="Injects a QT module to execute shell commands from QML"
	depends="xovi"

	install -Dm755 "$srcdir/qt-command-executor.so" \
		"$subpkgdir/home/root/xovi/extensions.d/qt-command-executor.so"
}

fileman() {
	pkgdesc="Module for managing filesystem redirections"
	depends="xovi"

	install -Dm755 "$srcdir/fileman.so" \
		"$subpkgdir/home/root/xovi/extensions.d/fileman.so"
}

framebuffer_spy() {
	pkgdesc="Module for exposing the address of the system framebuffer"
	depends="xovi"

	install -Dm755 "$srcdir/framebuffer-spy.so" \
		"$subpkgdir/home/root/xovi/extensions.d/framebuffer-spy.so"
}

random_suspend() {
	pkgdesc="Randomize your reMarkable tablet's suspend screens"
	depends="xovi-fileman"

	install -Dm755 "$srcdir/random-suspend-screen.so" \
		"$subpkgdir/home/root/xovi/extensions.d/random-suspend-screen.so"
}
