maintainer="Mitchell Scott <mitchell@scottlabs.io>"
pkgname=xovi
pkgver=0.3.2
pkgrel=0
_upstream_author="asivery"
_category="framework"
pkgdesc="Core xovi framework for reMarkable tablets"
url="https://github.com/asivery/xovi"
arch="aarch64 armv7"
license="GPL-3.0"
install="$pkgname.pre-deinstall"
options="!check !fhs !strip !tracedeps"

source="
xovi-aarch64.so::https://github.com/asivery/xovi/releases/download/v$pkgver/xovi-aarch64.so
xovi-armv7.so::https://github.com/asivery/xovi/releases/download/v$pkgver/xovi-arm32.so
LICENSE::https://raw.githubusercontent.com/asivery/xovi/master/LICENSE
"


package() {
	mkdir -p "$pkgdir/home/root/xovi/extensions.d"
	mkdir -p "$pkgdir/home/root/xovi/exthome"

	case "$CARCH" in
		aarch64) _xovi_so="xovi-aarch64.so" ;;
		armv7|armhf) _xovi_so="xovi-armv7.so" ;;
	esac

	install -Dm755 "$srcdir/$_xovi_so" "$pkgdir/home/root/xovi/xovi.so"

	cat > "$pkgdir/home/root/xovi/debug" <<-'EOF'
	#!/bin/bash
	systemctl stop xochitl
	QML_DISABLE_DISK_CACHE=1 QML_XHR_ALLOW_FILE_READ=1 QML_XHR_ALLOW_FILE_WRITE=1 LD_PRELOAD=/home/root/xovi/xovi.so xochitl
	EOF

	cat > "$pkgdir/home/root/xovi/start" <<-'EOF'
	#!/bin/bash
	mkdir -p /etc/systemd/system/xochitl.service.d
	mount -t tmpfs tmpfs /etc/systemd/system/xochitl.service.d
	cat > /etc/systemd/system/xochitl.service.d/xovi.conf <<-END
	[Service]
	Environment="QML_DISABLE_DISK_CACHE=1"
	Environment="QML_XHR_ALLOW_FILE_WRITE=1"
	Environment="QML_XHR_ALLOW_FILE_READ=1"
	Environment="LD_PRELOAD=/home/root/xovi/xovi.so"
	END

	systemctl daemon-reload
	systemctl restart xochitl
	EOF

	cat > "$pkgdir/home/root/xovi/stock" <<-'EOF'
	#!/bin/bash
	rm -f /etc/systemd/system/xochitl.service.d/xovi.conf
	systemctl daemon-reload
	systemctl restart xochitl
	EOF

	chmod 755 "$pkgdir/home/root/xovi/debug"
	chmod 755 "$pkgdir/home/root/xovi/start"
	chmod 755 "$pkgdir/home/root/xovi/stock"

	install -Dm644 "$srcdir/LICENSE" \
		"$pkgdir/home/root/.vellum/licenses/$pkgname/LICENSE"
	echo "https://github.com/asivery/xovi/archive/refs/tags/v$pkgver.tar.gz" > \
		"$pkgdir/home/root/.vellum/licenses/$pkgname/SOURCES"
}
sha512sums="
72570b63fcd072a20abba298715334d1b9ecce6f8ae02b53c09bfe4c61263f95eb78302b494d3337e173841d3eaf840c14fbb4b4d9c76292bbb5e9389ee8870c  xovi-aarch64.so
6ad3b6db12ae486357d50aaaf2d8a257cdadec0d7a1ac7b27029db7357f6588962cba3309ae6a2298cfaebe2694d1f0264c2753c1252a6dd223fd138f6ee996d  xovi-armv7.so
d361e5e8201481c6346ee6a886592c51265112be550d5224f1a7a6e116255c2f1ab8788df579d9b8372ed7bfd19bac4b6e70e00b472642966ab5b319b99a2686  LICENSE
"
