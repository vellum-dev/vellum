maintainer="Mitchell Scott <mitchell@scottlabs.io>"
pkgname=tripletap
pkgver=1.0.0
pkgrel=1
upstream_author="rmitchellscott"
category="utilities"
pkgdesc="Start xovi by triple-pressing the power button"
url="https://github.com/rmitchellscott/xovi-tripletap"
arch="aarch64 armv7"
license="MIT"
depends="xovi mount-utils"
source="
$pkgname-$pkgver.tar.gz::https://github.com/rmitchellscott/xovi-tripletap/archive/v$pkgver.tar.gz
LICENSE::https://raw.githubusercontent.com/rmitchellscott/xovi-tripletap/v$pkgver/LICENSE
"
options="!check !fhs !strip !tracedeps"
builddir="$srcdir/xovi-tripletap-$pkgver"

package() {
	local install_dir="$pkgdir/home/root/xovi-tripletap"
	mkdir -p "$install_dir"

	case "$CARCH" in
		aarch64)
			install -Dm755 evtest.arm64 "$install_dir/evtest"
			;;
		armv7)
			install -Dm755 evtest.arm32 "$install_dir/evtest"
			;;
	esac

	install -Dm755 main.sh "$install_dir/main.sh"
	install -Dm755 enable.sh "$install_dir/enable.sh"
	install -Dm755 uninstall.sh "$install_dir/uninstall.sh"
	install -Dm755 version-switcher.sh "$install_dir/version-switcher.sh"
	install -Dm755 init-version-switching.sh "$install_dir/init-version-switching.sh"
	install -Dm755 prepare-new-version.sh "$install_dir/prepare-new-version.sh"
	install -Dm755 disable-version-switching.sh "$install_dir/disable-version-switching.sh"
	install -Dm755 press-and-hold.sh "$install_dir/press-and-hold.sh"

	install -Dm644 config.default "$install_dir/config.default"
	install -Dm755 migrate-to-config.sh "$install_dir/migrate-to-config.sh"

	install -Dm644 xovi-tripletap.service "$install_dir/xovi-tripletap.service"

	echo "$pkgver" > "$install_dir/version.txt"

	install -Dm644 "$srcdir/LICENSE" \
		"$pkgdir/home/root/.vellum/licenses/$pkgname/LICENSE"
	echo "https://github.com/$upstream_author/xovi-tripletap/archive/v$pkgver.tar.gz" > \
		"$pkgdir/home/root/.vellum/licenses/$pkgname/SOURCES"

	install -Dm755 "$startdir/$pkgname.post-os-upgrade" \
		"$pkgdir/home/root/.vellum/hooks/post-os-upgrade/$pkgname"
}

postinstall(){
	/home/root/xovi-tripletap/enable.sh
}

preupgrade(){
	CONFIG_FILE="/home/root/xovi-tripletap/config"
	MAIN_SH="/home/root/xovi-tripletap/main.sh"

	[ -f "$CONFIG_FILE" ] && exit 0

	DEFAULT_ENABLE_VERSION_SWITCHING="false"
	DEFAULT_TRIGGER_ACTION='"start"'
	DEFAULT_TIME_THRESHOLD="2"
	DEFAULT_REQUIRED_PRESSES="3"

	if [ -f "$MAIN_SH" ]; then
		ENABLE_VERSION_SWITCHING=$(grep -E '^ENABLE_VERSION_SWITCHING=' "$MAIN_SH" | head -n 1 | cut -d'=' -f2 | cut -d'#' -f1 | tr -d ' ')
		TRIGGER_ACTION=$(grep -E '^TRIGGER_ACTION=' "$MAIN_SH" | head -n 1 | cut -d'=' -f2 | cut -d'#' -f1 | tr -d ' ')
		TIME_THRESHOLD=$(grep -E '^TIME_THRESHOLD=' "$MAIN_SH" | head -n 1 | cut -d'=' -f2 | tr -d ' ' | cut -d'#' -f1 | tr -d ' ')
		REQUIRED_PRESSES=$(grep -E '^REQUIRED_PRESSES=' "$MAIN_SH" | head -n 1 | cut -d'=' -f2 | tr -d ' ' | cut -d'#' -f1 | tr -d ' ')
	fi

	ENABLE_VERSION_SWITCHING=${ENABLE_VERSION_SWITCHING:-$DEFAULT_ENABLE_VERSION_SWITCHING}
	TRIGGER_ACTION=${TRIGGER_ACTION:-$DEFAULT_TRIGGER_ACTION}
	TIME_THRESHOLD=${TIME_THRESHOLD:-$DEFAULT_TIME_THRESHOLD}
	REQUIRED_PRESSES=${REQUIRED_PRESSES:-$DEFAULT_REQUIRED_PRESSES}

	cat > "$CONFIG_FILE" << EOF
ENABLE_VERSION_SWITCHING=${ENABLE_VERSION_SWITCHING}
TRIGGER_ACTION=${TRIGGER_ACTION}
TIME_THRESHOLD=${TIME_THRESHOLD}
REQUIRED_PRESSES=${REQUIRED_PRESSES}
PRE_START_COMMANDS=()
POST_START_COMMANDS=()
EOF
}

postupgrade(){
	/home/root/xovi-tripletap/enable.sh
}

postosupgrade(){
	cp /home/root/xovi-tripletap/xovi-tripletap.service /etc/systemd/system/
	systemctl daemon-reload
	systemctl enable xovi-tripletap --now
}

predeinstall(){
	/home/root/.vellum/bin/mount-rw

	if [ "$VELLUM_PURGE" = "1" ]; then
		/home/root/xovi-tripletap/uninstall.sh
	else
		systemctl stop xovi-tripletap 2>/dev/null || true
		systemctl disable xovi-tripletap 2>/dev/null || true
		rm -f /etc/systemd/system/xovi-tripletap.service
		systemctl daemon-reload

		if [ -f /home/root/xovi-tripletap/config ]; then
			echo "Note: /home/root/xovi-tripletap/config preserved"
			echo "      Use 'vellum purge tripletap' to remove everything"
		fi
	fi

	/home/root/.vellum/bin/mount-restore
}

sha512sums="
0ae119c57a2829877fb0ed7e82eea23938e1ad97d226b428e1e18b7f074ad3f35e0be520c2fc1d47f82151c0975bf54b4adc40c5eae9af68726633effed17b2f  tripletap-1.0.0.tar.gz
b7a86c9fc7a740ff680037b0e6b646ccd70e4e74fef78669b8ba92e18b873e4673fbba064272c595d13bc016288cd4a0532cd974534b7fef43a5b065f24add95  LICENSE
"
