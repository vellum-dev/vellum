maintainer="Interloper <45214659+0xdeb7ef@users.noreply.github.com>"
pkgname=tailscale
pkgver=1.94.1
pkgrel=0
upstream_author="tailscale"
category="utilities"
pkgdesc="Tailscale VPN client"
url="https://tailscale.com"
arch="aarch64 armv7"
license="BSD-3-Clause"
options="!check !fhs !strip !tracedeps"
depends="mount-utils"

source="
https://dl.tailscale.com/stable/tailscale_${pkgver}_arm.tgz
https://dl.tailscale.com/stable/tailscale_${pkgver}_arm64.tgz
https://raw.githubusercontent.com/tailscale/tailscale/refs/tags/v$pkgver/LICENSE
10-defaults.patch
10-service.patch
$pkgname.post-os-upgrade
"

unpack() {
	if [ -z "$force" ]; then
		verify
		initdcheck
	fi

	case "$CARCH" in
		aarch64) _arch="arm64" ;;
		armv7) _arch="arm" ;;
	esac

	mkdir -p "$srcdir"
	_tar="$SRCDEST/tailscale_${pkgver}_$_arch.tgz"

	msg "Unpacking $_tar..."
	tar -C "$srcdir" -zxf "$_tar"
	mkdir -p "$srcdir/$pkgname-$pkgver"
	mv "$srcdir/tailscale_${pkgver}_$_arch" "$srcdir/$pkgname-$pkgver/tailscale"
	msg "Unpacked."
}

package() {
	install -Dm644 "$srcdir/LICENSE" \
		"$pkgdir/home/root/.vellum/licenses/$pkgname/LICENSE"
	echo "https://github.com/tailscale/tailscale/tree/$pkgver/licenses" > \
		"$pkgdir/home/root/.vellum/licenses/$pkgname/LICENSES-3RD-PARTY"

	cd "$srcdir/$pkgname-$pkgver/tailscale"

	install -Dm744 tailscaled \
		"$pkgdir/home/root/.vellum/bin/tailscaled"
	install -Dm744 tailscale \
		"$pkgdir/home/root/.vellum/bin/tailscale"

	install -Dm644 systemd/tailscaled.defaults \
		"$pkgdir/home/root/.vellum/etc/default/tailscaled"

	# install a backup .service file for use with post-os-upgrade
	install -Dm644 systemd/tailscaled.service \
		"$pkgdir/home/root/.vellum/share/tailscale/systemd/tailscaled.service"
	install -Dm755 "$startdir/$pkgname.post-os-upgrade" \
		"$pkgdir/home/root/.vellum/hooks/post-os-upgrade/$pkgname"
}

postinstall(){
	/home/root/.vellum/bin/mount-rw

	echo "installing tailscaled.service..."
	cp /home/root/.vellum/share/tailscale/systemd/tailscaled.service /etc/systemd/system/tailscaled.service

	echo "reloading systemd daemon"
	systemctl daemon-reload

	echo "enabling tailscaled service..."
	systemctl enable tailscaled.service

	/home/root/.vellum/bin/mount-restore

	echo "restarting tailscaled service..."
	systemctl restart tailscaled.service
}

postupgrade(){
	/home/root/.vellum/bin/mount-rw

	echo "installing tailscaled.service..."
	cp /home/root/.vellum/share/tailscale/systemd/tailscaled.service /etc/systemd/system/tailscaled.service

	echo "reloading systemd daemon"
	systemctl daemon-reload

	echo "enabling tailscaled service..."
	systemctl enable tailscaled.service

	/home/root/.vellum/bin/mount-restore

	echo "restarting tailscaled service..."
	systemctl restart tailscaled.service
}

postosupgrade(){
	echo " * re-installing tailscaled.service..."
	cp /home/root/.vellum/share/tailscale/systemd/tailscaled.service /etc/systemd/system/tailscaled.service

	echo " * reloading systemd daemon"
	systemctl daemon-reload

	echo " * enabling tailscaled service..."
	systemctl enable tailscaled.service

	echo " * restarting tailscaled service..."
	systemctl restart tailscaled.service
}

predeinstall(){
	/home/root/.vellum/bin/mount-rw

	echo "stopping tailscaled service..."
	systemctl disable --now tailscaled.service

	echo "removing tailscaled.service..."
	rm -f /etc/systemd/system/tailscaled.service

	/home/root/.vellum/bin/mount-restore

	echo "reloading systemd daemon"
	systemctl daemon-reload

	if [ "$VELLUM_PURGE" = "1" ]; then
		echo "deleting tailscale config files..."
		rm -rf \
			/home/root/.local/var/lib/tailscale \
			/home/root/.config/tailscale
	fi
}

sha512sums='
861b8b7103707f7a9ee4719e136429759d903c9f61c435803ede82ee65cb93fac38f3133a7edcc537b6f2d00976426ebd751031cbf93a355d01aef3f7e88866b  tailscale_1.94.1_arm.tgz
93fba9144a3df577c11dfb31dd92ef9635daf8dd52e599adf370c926d6e4aab8066f8b0711556af50db52802365f9b363c757a4509736dce8faad5c0cc57cc11  tailscale_1.94.1_arm64.tgz
d9e05b6d2d70e945ab5c968cfcffa3bf5d5399058c9721bd2198d89c1a5466f137bcaa4ff5a1aaf81ee08f7c7c197607b1d73d3f472f158b877d8df9fa71c790  LICENSE
665463289bf08707b57c4ff165c131854270dbe026a626f1c66450b66f1a8ad9cccbdd30be574a72e8c237e7acf8cb879ca5451dd853ade645bb89ec117d278a  10-defaults.patch
d6c9a6a3f0230d1e9fff6366013078c823070621c1cfd5efbac80215ec32019d4192d631428f69d0d362f0069998ce0137f037bc8a9a1886c75bc41896df88cd  10-service.patch
2100dd4f6936569ea683d6cec4e55a5d5940edb9dd9a4f75dff5faa1a7037af3c817a1a6987796f4ad96d2958b8943ebb236141f359428520d57a760f36a58aa  tailscale.post-os-upgrade
'
