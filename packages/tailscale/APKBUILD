maintainer="Interloper <45214659+0xdeb7ef@users.noreply.github.com>"
pkgname=tailscale
pkgver=1.94.1
pkgrel=0
_upstream_author="tailscale"
_category="utilities"
pkgdesc="Tailscale VPN client"
url="https://tailscale.com"
arch="aarch64 armv7"
license="BSD-3-Clause"
options="!check !fhs !strip !tracedeps"
depends="mount-utils"
install="
$pkgname.post-install
$pkgname.post-deinstall
$pkgname.pre-deinstall
$pkgname.post-upgrade
"
builddir="$srcdir/tailscale_${pkgver}_$_arch"

case "$CARCH" in
	aarch64) _arch="arm64" ;;
	armv7 | armhf) _arch="arm" ;;
esac

source="
https://dl.tailscale.com/stable/tailscale_${pkgver}_arm.tgz
https://dl.tailscale.com/stable/tailscale_${pkgver}_arm64.tgz
https://raw.githubusercontent.com/tailscale/tailscale/refs/tags/v$pkgver/LICENSE
10-defaults.patch
10-service.patch
$pkgname.post-os-upgrade
"

unpack() {
	if [ -z "$force" ]; then
		verify
		initdcheck
	fi

	mkdir -p "$srcdir"
	_tar="$SRCDEST/tailscale_${pkgver}_$_arch.tgz"

	msg "Unpacking $_tar..."
	tar -C "$srcdir" -zxf "$_tar"
}

package() {
	cd "$srcdir"

	install -Dm644 LICENSE \
	    "$pkgdir/home/root/.vellum/licenses/$pkgname/LICENSE"
	echo "https://github.com/tailscale/tailscale/tree/$pkgver/licenses" > \
		"$pkgdir/home/root/.vellum/licenses/$pkgname/LICENSES-3RD-PARTY"

	cd "tailscale_${pkgver}_$_arch"

	install -Dm744 tailscaled \
	    "$pkgdir/home/root/.vellum/bin/tailscaled"
	install -Dm744 tailscale \
	    "$pkgdir/home/root/.vellum/bin/tailscale"

	install -Dm644 systemd/tailscaled.defaults \
		"$pkgdir/home/root/.vellum/etc/default/tailscaled"

	install -Dm644 systemd/tailscaled.service \
		"$pkgdir/etc/systemd/system/tailscaled.service"

	# install a backup .service file for use with post-os-upgrade
	install -Dm644 systemd/tailscaled.service \
		"$pkgdir/home/root/.vellum/share/tailscale/systemd/tailscaled.service"
	install -Dm755 "$startdir/$pkgname.post-os-upgrade" \
		"$pkgdir/home/root/.vellum/hooks/post-os-upgrade/$pkgname"
}

sha512sums="
861b8b7103707f7a9ee4719e136429759d903c9f61c435803ede82ee65cb93fac38f3133a7edcc537b6f2d00976426ebd751031cbf93a355d01aef3f7e88866b  tailscale_1.94.1_arm.tgz
93fba9144a3df577c11dfb31dd92ef9635daf8dd52e599adf370c926d6e4aab8066f8b0711556af50db52802365f9b363c757a4509736dce8faad5c0cc57cc11  tailscale_1.94.1_arm64.tgz
d9e05b6d2d70e945ab5c968cfcffa3bf5d5399058c9721bd2198d89c1a5466f137bcaa4ff5a1aaf81ee08f7c7c197607b1d73d3f472f158b877d8df9fa71c790  LICENSE
b0cbcd5e94001fc8f91ae6bc0dca40bac8f34d92112d2a0ad83189c8e6bb79fe415dce9dda6a554c8094a59f1bfd6bf1109439c47ef5f1d0b3eb522af3a62c95  10-defaults.patch
9659570ce0a1c0b1368e30934cf7b126ebd774d5958d23d65571a0cd9685af73e3d46d51fc4ff68f8cb080edc97041789bd70093f1ca46bd65f88aaac55f3d56  10-service.patch
69c9a2b83965dd69cbfe3d55b26b0dcc41fd93cd264cc6d9ff8091b30c17e8001e4df93beba029cac60f457127cd5d790225ed9ada807259b75fba15795a1bc9  tailscale.post-os-upgrade
"
