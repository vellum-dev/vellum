maintainer="Interloper <45214659+0xdeb7ef@users.noreply.github.com>"
pkgname="vnsee-qtfb"
pkgver=1.1.0
pkgrel=0
_upstream_author="khyryra"
_category="apps"
pkgdesc="VNC client for the reMarkable tablet allowing you to use the device as a second screen"
url="https://github.com/khyryra/vnsee-qtfb"
arch="aarch64 armv7"
license="GPL-3.0"
options="!check !fhs !strip !tracedeps"

# Generate install script symlinks at build time
for _dev in rm1 rm2 rmpp rmppm; do
	[ -e "$startdir/$pkgname-$_dev.post-install" ] || \
		ln -s "$pkgname.post-install" "$startdir/$pkgname-$_dev.post-install" 2>/dev/null || true
	[ -e "$startdir/$pkgname-$_dev.post-deinstall" ] || \
		ln -s "$pkgname.post-deinstall" "$startdir/$pkgname-$_dev.post-deinstall" 2>/dev/null || true
done

case "$CARCH" in
	armv7)
		subpackages="$pkgname-rm1:_device $pkgname-rm2:_device"
		_devices="rm1:rm1 rm2:rm2"
		;;
	aarch64)
		subpackages="$pkgname-rmpp:_device $pkgname-rmppm:_device"
		_devices="rmpp:ferrari rmppm:chiappa"
		;;
esac

source="
vnsee-rm1-$pkgver.zip::https://github.com/khyryra/vnsee-qtfb/releases/download/v$pkgver/vnsee-rm1.zip
vnsee-rm2-$pkgver.zip::https://github.com/khyryra/vnsee-qtfb/releases/download/v$pkgver/vnsee-rm2.zip
vnsee-ferrari-$pkgver.zip::https://github.com/khyryra/vnsee-qtfb/releases/download/v$pkgver/vnsee-ferrari.zip
vnsee-chiappa-$pkgver.zip::https://github.com/khyryra/vnsee-qtfb/releases/download/v$pkgver/vnsee-chiappa.zip
LICENSE.md::https://raw.githubusercontent.com/khyryra/vnsee-qtfb/master/LICENSE.md
"

prepare() {
	default_prepare
	cd "$srcdir"

	for device_map in $_devices; do
		device="${device_map%%:*}"
		upstream="${device_map##*:}"
		mkdir -p "$device"
		unzip -o "vnsee-$upstream-$pkgver.zip" -d "$device"
	done
}

package() {
	mkdir -p "$pkgdir"
}

_device() {
	local device="${subpkgname##*-}"
	pkgdesc="$pkgdesc ($device)"
	depends="appload $device"
	provides="vnsee-qtfb"
	install="$subpkgname.post-install $subpkgname.post-deinstall"

	mkdir -p "$subpkgdir/home/root/xovi/exthome/appload"
	cp -r "$srcdir/$device/vnsee" "$subpkgdir/home/root/xovi/exthome/appload/vnsee"
	cp -r "$srcdir/$device/vnsee-0" "$subpkgdir/home/root/xovi/exthome/appload/vnsee-0"
	cp -r "$srcdir/$device/vnsee-1" "$subpkgdir/home/root/xovi/exthome/appload/vnsee-1"
	cp -r "$srcdir/$device/vnsee-2" "$subpkgdir/home/root/xovi/exthome/appload/vnsee-2"
	cp -r "$srcdir/$device/vnsee-3" "$subpkgdir/home/root/xovi/exthome/appload/vnsee-3"

	install -Dm644 "$srcdir/LICENSE.md" \
		"$subpkgdir/home/root/.vellum/licenses/$pkgname/LICENSE"
	echo "https://github.com/khyryra/vnsee-qtfb/archive/v$pkgver.tar.gz" > \
		"$subpkgdir/home/root/.vellum/licenses/$pkgname/SOURCES"
}

sha512sums="
084b953d9270c9051c7bf4fa4525fc20d540d9528c2f962d67485546981198600ceeb2caa61ae07723d1f06cddbf7c0742ceb7fb88f2648cedf7bc38402ae52f  vnsee-rm1-1.1.0.zip
12372589ae6e220b9fd80323889797d932c41062a45ffa960e07ecfd81ded97125fbf6aee87ee7917a0b97cb3898a5658615b3bd4478a6c736803e7fe1ca512f  vnsee-rm2-1.1.0.zip
3ca1a84e4e42c06219eecb456963e5fad3b135dfe41bf9cea3d321f9347d8a19f20868ec0aabf120431135ceb8fe04f011ddcbda3fdc8be449224e33523e1d5e  vnsee-ferrari-1.1.0.zip
bc4d83781d3b6d44d5a1350c1ebc48c5d46db2f6b7a1918891dedf7c6efe8c6d88f493a3ffac2e1052cdf3cad2d106d0d8868246bf09981ad2d806e0360a4937  vnsee-chiappa-1.1.0.zip
d361e5e8201481c6346ee6a886592c51265112be550d5224f1a7a6e116255c2f1ab8788df579d9b8372ed7bfd19bac4b6e70e00b472642966ab5b319b99a2686  LICENSE.md
"
