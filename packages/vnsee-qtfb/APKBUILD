maintainer="Interloper <45214659+0xdeb7ef@users.noreply.github.com>"
pkgname=vnsee-qtfb
pkgver=1.1.0
pkgrel=1
_upstream_author="khyryra"
_category="apps"
pkgdesc="VNC client for the reMarkable tablet allowing you to use the device as a second screen"
url="https://github.com/khyryra/vnsee-qtfb"
license="GPL-3.0"
arch="aarch64 armv7"
options="!check !fhs !strip !tracedeps"

# device:upstream_zip:hardware_virtual
case "$CARCH" in
	armv7)
		_devices="
			rm1:rm1:rm1
			rm2:rm2:rm2
		"
		;;
	aarch64)
		_devices="
			rmpp:ferrari:rmpp
			rmppm:chiappa:rmppm
		"
		;;
esac

for _d in $_devices; do
	_dev="${_d%%:*}"
	subpackages="$subpackages vnsee-qtfb-$_dev:_device"
	install="$install vnsee-qtfb-$_dev.post-install vnsee-qtfb-$_dev.post-upgrade vnsee-qtfb-$_dev.post-deinstall"
done

# Generate install script symlinks
for dev in rm1 rm2 rmpp rmppm; do
	[ -e "$startdir/vnsee-qtfb-$dev.post-install" ] || \
		ln -s vnsee-qtfb.post-install "$startdir/vnsee-qtfb-$dev.post-install" 2>/dev/null || true
	[ -e "$startdir/vnsee-qtfb-$dev.post-upgrade" ] || \
		ln -s vnsee-qtfb.post-upgrade "$startdir/vnsee-qtfb-$dev.post-upgrade" 2>/dev/null || true
	[ -e "$startdir/vnsee-qtfb-$dev.post-deinstall" ] || \
		ln -s vnsee-qtfb.post-deinstall "$startdir/vnsee-qtfb-$dev.post-deinstall" 2>/dev/null || true
done

source="
https://github.com/khyryra/vnsee-qtfb/releases/download/v$pkgver/vnsee-rm1.zip
https://github.com/khyryra/vnsee-qtfb/releases/download/v$pkgver/vnsee-rm2.zip
https://github.com/khyryra/vnsee-qtfb/releases/download/v$pkgver/vnsee-ferrari.zip
https://github.com/khyryra/vnsee-qtfb/releases/download/v$pkgver/vnsee-chiappa.zip
https://raw.githubusercontent.com/khyryra/vnsee-qtfb/master/LICENSE.md
"

unpack() {
	for d in $_devices; do
		dev="${d%%:*}"
		tmp="${d#*:}"
		upstream="${tmp%%:*}"

		mkdir -p "$dev"
		unzip -o "$srcdir/vnsee-$upstream.zip" -d "$srcdir/$dev"
	done
}

package() {
	mkdir -p "$pkgdir"
}

_device() {
	local dev="${subpkgname##*-}"

	for d in $_devices; do
		[ "${d%%:*}" = "$dev" ] || continue
		tmp="${d#*:}"
		hw="${tmp#*:}"
		break
	done

	pkgdesc="$pkgdesc ($dev)"
	depends="appload"
	install_if="$pkgname=$pkgver-r$pkgrel $hw"

	mkdir -p "$subpkgdir/home/root/xovi/exthome/appload"

	for n in "" -0 -1 -2 -3; do
		cp -r "$srcdir/$dev/vnsee$n" \
			"$subpkgdir/home/root/xovi/exthome/appload/vnsee$n"
	done

	install -Dm644 "$srcdir/LICENSE.md" \
		"$subpkgdir/home/root/.vellum/licenses/vnsee-qtfb/LICENSE"

	echo "https://github.com/khyryra/vnsee-qtfb/archive/v$pkgver.tar.gz" > \
		"$subpkgdir/home/root/.vellum/licenses/vnsee-qtfb/SOURCES"
}

sha512sums="
084b953d9270c9051c7bf4fa4525fc20d540d9528c2f962d67485546981198600ceeb2caa61ae07723d1f06cddbf7c0742ceb7fb88f2648cedf7bc38402ae52f  vnsee-rm1.zip
12372589ae6e220b9fd80323889797d932c41062a45ffa960e07ecfd81ded97125fbf6aee87ee7917a0b97cb3898a5658615b3bd4478a6c736803e7fe1ca512f  vnsee-rm2.zip
3ca1a84e4e42c06219eecb456963e5fad3b135dfe41bf9cea3d321f9347d8a19f20868ec0aabf120431135ceb8fe04f011ddcbda3fdc8be449224e33523e1d5e  vnsee-ferrari.zip
bc4d83781d3b6d44d5a1350c1ebc48c5d46db2f6b7a1918891dedf7c6efe8c6d88f493a3ffac2e1052cdf3cad2d106d0d8868246bf09981ad2d806e0360a4937  vnsee-chiappa.zip
d361e5e8201481c6346ee6a886592c51265112be550d5224f1a7a6e116255c2f1ab8788df579d9b8372ed7bfd19bac4b6e70e00b472642966ab5b319b99a2686  LICENSE.md
"
