maintainer="Mitchell Scott <mitchell@scottlabs.io>"
pkgname=xovi-extensions
pkgver=17.0.0
pkgrel=5
_upstream_author="asivery"
_category="framework"
pkgdesc="Extensions for xovi framework"
url="https://github.com/asivery/rm-xovi-extensions"
arch="aarch64 armv7"
license="GPL-3.0"
depends="xovi remarkable-os>=3.20 remarkable-os<3.26"
options="!check !fhs !strip !tracedeps"
install="qt-resource-rebuilder.post-install"

subpackages="
	qt-resource-rebuilder:qt_resource_rebuilder
	qt-command-executor:qt_command_executor
	xovi-message-broker:message_broker
	webserver-remote:webserver_remote
"

_release="v17-14012026"

source="
https://github.com/asivery/rm-xovi-extensions/releases/download/$_release/extensions-aarch64.zip
https://github.com/asivery/rm-xovi-extensions/releases/download/$_release/extensions-arm32-testing.zip
https://raw.githubusercontent.com/asivery/rm-xovi-extensions/refs/heads/master/xovi-setup/debug
https://raw.githubusercontent.com/asivery/rm-xovi-extensions/refs/heads/master/xovi-setup/start
https://raw.githubusercontent.com/asivery/rm-xovi-extensions/refs/heads/master/xovi-setup/stock
rebuild_hashtable
https://raw.githubusercontent.com/asivery/rm-xovi-extensions/refs/heads/master/xovi-setup/scripts/debug/qt-resource-rebuilder.sh
https://raw.githubusercontent.com/asivery/rm-xovi-extensions/refs/heads/master/xovi-setup/services/xochitl.service/qt-resource-rebuilder.conf
https://raw.githubusercontent.com/asivery/rm-xovi-extensions/master/LICENSE
"


unpack() {
	case "$CARCH" in
		aarch64) unzip -o "$srcdir"/extensions-aarch64.zip -d "$srcdir" ;;
		armv7) unzip -o "$srcdir"/extensions-arm32-testing.zip -d "$srcdir" ;;
	esac
}

package() {
	install -d "$pkgdir"/home/root/xovi
	install -Dm755 "$srcdir"/debug "$pkgdir"/home/root/xovi/debug
	install -Dm755 "$srcdir"/start "$pkgdir"/home/root/xovi/start
	install -Dm755 "$srcdir"/stock "$pkgdir"/home/root/xovi/stock

	install -d "$pkgdir"/home/root/xovi/extensions.d
	install -d "$pkgdir"/home/root/xovi/exthome

	install -d "$pkgdir"/home/root/xovi/scripts
	install -d "$pkgdir"/home/root/xovi/scripts/debug
	install -d "$pkgdir"/home/root/xovi/scripts/pre-start
	install -d "$pkgdir"/home/root/xovi/scripts/post-start
	install -d "$pkgdir"/home/root/xovi/scripts/pre-stock
	install -d "$pkgdir"/home/root/xovi/scripts/post-stock

	install -d "$pkgdir"/home/root/xovi/services
	install -d "$pkgdir"/home/root/xovi/services/xochitl.service
	ln -s /home/root/xovi/extensions.d "$pkgdir"/home/root/xovi/services/xochitl.service/extensions.d
	ln -s /home/root/xovi/exthome "$pkgdir"/home/root/xovi/services/xochitl.service/exthome

	install -Dm644 "$srcdir"/LICENSE \
		"$pkgdir"/home/root/.vellum/licenses/$pkgname/LICENSE
	echo "https://github.com/asivery/rm-xovi-extensions/archive/refs/tags/$_release.tar.gz" > \
		"$pkgdir"/home/root/.vellum/licenses/$pkgname/SOURCES
}

qt_resource_rebuilder() {
	pkgdesc="Rebuilds QT resource databases on the fly to replace or add QML files"
	depends="$pkgname"

	install -Dm644 "$srcdir"/qt-resource-rebuilder.so \
		"$subpkgdir"/home/root/xovi/extensions.d/qt-resource-rebuilder.so
	install -d "$subpkgdir"/home/root/xovi/exthome/qt-resource-rebuilder

	install -Dm755 "$srcdir"/qt-resource-rebuilder.sh \
		"$subpkgdir"/home/root/xovi/scripts/debug/qt-resource-rebuilder.sh
	install -Dm644 "$srcdir"/qt-resource-rebuilder.conf \
		"$subpkgdir"/home/root/xovi/services/xochitl.service/qt-resource-rebuilder.conf
	
	install -Dm755 "$srcdir"/rebuild_hashtable \
		"$subpkgdir"/home/root/xovi/rebuild_hashtable
}

qt_command_executor() {
	pkgdesc="Injects a QT module to execute shell commands from QML"
	depends="$pkgname"

	install -Dm644 "$srcdir"/qt-command-executor.so \
		"$subpkgdir"/home/root/xovi/extensions.d/qt-command-executor.so
}

message_broker() {
	pkgdesc="IPC messaging between xovi extensions"
	depends="$pkgname"

	install -Dm644 "$srcdir"/xovi-message-broker.so \
		"$subpkgdir"/home/root/xovi/extensions.d/xovi-message-broker.so
}

webserver_remote() {
	_category="utilities"
	pkgdesc="Exposes the USB webserver to all interfaces with connection confirmation dialog"
	depends="qt-resource-rebuilder xovi-message-broker"

	install -Dm644 "$srcdir"/webserver-remote.so \
		"$subpkgdir"/home/root/xovi/extensions.d/webserver-remote.so
}
sha512sums="
bedd792ee72c0fc37246d292e7e030abd40fcebedc0ac99c1ee5d2df1e22920cefd4f09a4223bc547795ec33f4b1df97d190ac21dfbcac4c2c9d8b2ac087e68b  extensions-aarch64.zip
69561e979048454de51d4205ba45b0dcb5117909a690cc978c049cc61dc46aa227c1e93b7f1e970c0a8846b5d470a2f48244beb4c85df5eca080ce9c55c54dc6  extensions-arm32-testing.zip
f6209d7ab533c2deea8ab5f8d46a853bcd82c1fb3351e6229e693fe33bfccd4eb2454573c8ec26063d2243fbfcb991570e7c78dfce74dc273adcfd2cc222ed9a  debug
09acd8e2a10329a1d2f1ce688a80d8edb443bdc87a5149be7ff2094bafc340268b0043bd4b599cccd6bd25c651d4a24af98b851acefd773964e8eedf60b1f142  start
abc02ccdb7fdeb1ee255bab74d8c6e6e4d0a81f0362beb81b955b303573348e413066dcbd99d228e3c1cab8c6d4249db89ad48574d862b0e8f9918737c44a0c3  stock
872c0fdd95b1d8890fd8c1819a445225e2aafc81b22a7b09aad18962ad4700b4f1438290160828749372b904cc113efb69a33ddcadb06dfb58e5a74e2031d7de  rebuild_hashtable
e560edc946d934f27fa1151780ce43e0ab57388778df938ffec65a86343c7ddf57f790b2e9ffa0929a8ad4dd26c841c11db569e83820f720f68c49dd926f0290  qt-resource-rebuilder.sh
a98c41051c0e43aeada757d0000aa299ecb18c514b74710bab1a2b61caa04dbe90c9b1a21e383f407d1a5199f2291067293f38786a940bcfb43d0c7ef97cf106  qt-resource-rebuilder.conf
d361e5e8201481c6346ee6a886592c51265112be550d5224f1a7a6e116255c2f1ab8788df579d9b8372ed7bfd19bac4b6e70e00b472642966ab5b319b99a2686  LICENSE
"
