#!/bin/sh
set -e

VELLUM_ROOT="/home/root/.vellum"

get_os_version() {
    ver=$(grep RELEASE_VERSION /usr/share/remarkable/update.conf 2>/dev/null | cut -d= -f2 | tr -d '"')
    [ -z "$ver" ] && ver=$(grep IMG_VERSION /etc/os-release 2>/dev/null | cut -d= -f2 | tr -d '"')
    echo "$ver"
}

get_apk_arch() {
    case "$(uname -m)" in
        aarch64) echo "aarch64" ;;
        armv7l)  echo "armv7" ;;
        *)       echo "noarch" ;;
    esac
}

generate_remarkable_os_package() {
    VERSION="$1"
    APK_ARCH=$(get_apk_arch)
    PKG_DIR=$(mktemp -d)
    REPO_DIR="$VELLUM_ROOT/local-repo/$APK_ARCH"

    mkdir -p "$REPO_DIR"

    cat > "$PKG_DIR/.PKGINFO" <<EOF
pkgname = remarkable-os
pkgver = $VERSION-r0
pkgdesc = Virtual package representing reMarkable OS version
url = https://github.com/rmitchellscott/vellum
arch = noarch
license = MIT
provides = /bin/sh
EOF

    mkdir -p "$PKG_DIR/empty"
    tar -czf "$PKG_DIR/data.tar.gz" -C "$PKG_DIR/empty" .

    cd "$PKG_DIR"
    tar -czf "$REPO_DIR/remarkable-os-$VERSION-r0.apk" .PKGINFO data.tar.gz

    rm -rf "$PKG_DIR"
}

update_local_index() {
    APK_ARCH=$(get_apk_arch)
    REPO_DIR="$VELLUM_ROOT/local-repo/$APK_ARCH"
    INDEX_DIR=$(mktemp -d)
    LOCAL_KEY="$VELLUM_ROOT/etc/apk/keys/local.rsa"

    for apk in "$REPO_DIR/"*.apk; do
        [ -f "$apk" ] || continue

        PKGINFO=$(tar -xzf "$apk" -O .PKGINFO)
        CKSUM=$(openssl dgst -sha1 -binary "$apk" | openssl base64 | tr -d '\n')

        echo "C:Q1${CKSUM}" >> "$INDEX_DIR/APKINDEX"
        echo "$PKGINFO" | while IFS= read -r line; do
            key=$(echo "$line" | cut -d= -f1 | tr -d ' ')
            val=$(echo "$line" | cut -d= -f2- | sed 's/^ *//')
            case "$key" in
                pkgname) echo "P:$val" ;;
                pkgver) echo "V:$val" ;;
                arch) echo "A:$val" ;;
                pkgdesc) echo "T:$val" ;;
                url) echo "U:$val" ;;
                license) echo "L:$val" ;;
                provides) echo "p:$val" ;;
                depends) echo "D:$val" ;;
            esac
        done >> "$INDEX_DIR/APKINDEX"
        echo "S:$(stat -c %s "$apk" 2>/dev/null || stat -f %z "$apk")" >> "$INDEX_DIR/APKINDEX"
        echo "I:0" >> "$INDEX_DIR/APKINDEX"
        echo "" >> "$INDEX_DIR/APKINDEX"
    done

    cd "$INDEX_DIR"

    if [ -f "$LOCAL_KEY" ]; then
        tar -czf unsigned.tar.gz APKINDEX
        openssl dgst -sha1 -sign "$LOCAL_KEY" -out ".SIGN.RSA.local.rsa.pub" unsigned.tar.gz
        tar -cf sig.tar .SIGN.RSA.local.rsa.pub
        SIG_SIZE=$(stat -c %s ".SIGN.RSA.local.rsa.pub" 2>/dev/null || stat -f %z ".SIGN.RSA.local.rsa.pub")
        CONTENT_BLOCKS=$(( (512 + SIG_SIZE + 511) / 512 ))
        dd if=sig.tar bs=512 count=$CONTENT_BLOCKS 2>/dev/null | gzip -n -9 > sig.tar.gz
        cat sig.tar.gz unsigned.tar.gz > "$REPO_DIR/APKINDEX.tar.gz"
        rm -f unsigned.tar.gz sig.tar sig.tar.gz
    else
        tar -czf "$REPO_DIR/APKINDEX.tar.gz" APKINDEX
    fi

    rm -rf "$INDEX_DIR"
}

get_device_type() {
    MACHINE=$(cat /sys/devices/soc0/machine 2>/dev/null || echo "unknown")
    case "$MACHINE" in
        *ferrari*) echo "rmpp" ;;
        *chiappa*) echo "rmppm" ;;
        *) echo "rm2" ;;
    esac
}

generate_device_package() {
    DEVICE="$1"
    APK_ARCH=$(get_apk_arch)
    PKG_DIR=$(mktemp -d)
    REPO_DIR="$VELLUM_ROOT/local-repo/$APK_ARCH"

    mkdir -p "$REPO_DIR"

    case "$DEVICE" in
        rmpp) DESC="reMarkable Paper Pro" ;;
        rmppm) DESC="reMarkable Paper Pro Move" ;;
        rm2) DESC="reMarkable 2" ;;
        rm1) DESC="reMarkable 1" ;;
    esac

    cat > "$PKG_DIR/.PKGINFO" <<EOF
pkgname = $DEVICE
pkgver = 1.0.0-r0
pkgdesc = Virtual package for $DESC
url = https://github.com/rmitchellscott/vellum
arch = noarch
license = MIT
provides = $DEVICE
EOF

    mkdir -p "$PKG_DIR/empty"
    tar -czf "$PKG_DIR/data.tar.gz" -C "$PKG_DIR/empty" .

    cd "$PKG_DIR"
    tar -czf "$REPO_DIR/$DEVICE-1.0.0-r0.apk" .PKGINFO data.tar.gz

    rm -rf "$PKG_DIR"
}

ensure_device_package() {
    DEVICE=$(get_device_type)
    APK_ARCH=$(get_apk_arch)
    REPO_DIR="$VELLUM_ROOT/local-repo/$APK_ARCH"
    STATE_FILE="$VELLUM_ROOT/state/device"
    PREV_DEVICE=$(cat "$STATE_FILE" 2>/dev/null || true)

    if [ "$DEVICE" != "$PREV_DEVICE" ] || [ ! -f "$REPO_DIR/$DEVICE-1.0.0-r0.apk" ]; then
        mkdir -p "$REPO_DIR" "$VELLUM_ROOT/state"

        rm -f "$REPO_DIR/rm1-"*.apk "$REPO_DIR/rm2-"*.apk \
              "$REPO_DIR/rmpp-"*.apk "$REPO_DIR/rmppm-"*.apk

        generate_device_package "$DEVICE"
        update_local_index
        echo "$DEVICE" > "$STATE_FILE"

        "$VELLUM_ROOT/bin/apk.vellum" \
            --root "$VELLUM_ROOT" \
            --dest / \
            --no-logfile \
            add "$DEVICE" >/dev/null 2>&1 || true
    fi
}

ensure_remarkable_os() {
    CUR_VER=$(get_os_version)
    PREV_VER=$(cat "$VELLUM_ROOT/state/osver" 2>/dev/null || true)
    APK_ARCH=$(get_apk_arch)
    REPO_DIR="$VELLUM_ROOT/local-repo/$APK_ARCH"

    if [ "$CUR_VER" != "$PREV_VER" ]; then
        mkdir -p "$REPO_DIR" "$VELLUM_ROOT/state"
        rm -f "$REPO_DIR/remarkable-os-"*.apk
        generate_remarkable_os_package "$CUR_VER"
        update_local_index
        echo "$CUR_VER" > "$VELLUM_ROOT/state/osver"

        "$VELLUM_ROOT/bin/apk.vellum" \
            --root "$VELLUM_ROOT" \
            --dest / \
            --no-logfile \
            add remarkable-os >/dev/null 2>&1 || true
    fi
}

ensure_remarkable_os
ensure_device_package

export APK_CONFIG="$VELLUM_ROOT/etc/apk/config"

exec "$VELLUM_ROOT/bin/apk.vellum" \
    --root "$VELLUM_ROOT" \
    --dest / \
    --no-logfile \
    "$@"
